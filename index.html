<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Screen Share</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #007aff; --bg: #000000; --panel: #1c1c1e; --text: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .video-section { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        .overlay-btn { position: absolute; z-index: 100; background: var(--primary); color: white; border: none; padding: 20px 40px; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; display: none; box-shadow: 0 4px 15px rgba(0,122,255,0.5); }
        
        .ui-panel { background: var(--panel); padding: 20px; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; gap: 15px; }
        .input-group { display: flex; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid #333; background: #2c2c2e; color: #fff; font-size: 16px; outline: none; }
        
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 15px; cursor: pointer; transition: 0.2s; }
        .btn-host { background: var(--primary); color: white; }
        .btn-view { background: #32d74b; color: white; }
        .btn-stop { background: #ff453a; color: white; display: none; width: 100%; }

        #status { font-size: 12px; color: #8e8e93; text-align: center; }
        .loader { width: 20px; height: 20px; border: 3px solid #333; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; display: none; margin: 0 auto 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="video-section">
    <div id="statusIndicator" class="loader"></div>
    <button id="playBtn" class="overlay-btn" onclick="manualPlay()">▶ 画面を表示する</button>
    <video id="mainVideo" autoplay playsinline webkit-playsinline></video>
</div>

<div class="ui-panel">
    <div id="status">ルームIDを入力して開始</div>
    <div class="input-group" id="inputArea">
        <input type="text" id="roomId" placeholder="例: room777" spellcheck="false">
    </div>
    <div class="btn-row" id="controlBtns">
        <button class="btn-host" onclick="actAsHost()">配信(PC)</button>
        <button class="btn-view" onclick="actAsViewer()">視聴</button>
    </div>
    <button id="stopBtn" class="btn-stop" onclick="terminate()">終了する</button>
</div>

<script>
    let peer = null;
    let localStream = null;
    const videoEl = document.getElementById('mainVideo');
    const statusEl = document.getElementById('status');
    const playBtn = document.getElementById('playBtn');
    const loader = document.getElementById('statusIndicator');

    function updateStatus(msg, loading = false) {
        statusEl.innerText = msg;
        loader.style.display = loading ? 'block' : 'none';
    }

    async function manualPlay() {
        try {
            await videoEl.play();
            playBtn.style.display = 'none';
        } catch (e) {
            console.error("Play failed", e);
        }
    }

    // --- ホスト側 (配信) ---
    async function actAsHost() {
        const id = document.getElementById('roomId').value.trim();
        if (!id) return alert("IDを入力してください");

        try {
            localStream = await navigator.mediaDevices.getDisplayMedia({
                video: { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { max: 30 } },
                audio: true
            });
            videoEl.srcObject = localStream;
            videoEl.muted = true;

            peer = new Peer(id, { config: { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] }, debug: 1 });

            peer.on('open', () => {
                updateStatus(`配信中: ID「${id}」を相手に入力させてください`);
                showStopButton();
            });

            peer.on('call', (call) => {
                updateStatus("視聴者が接続しました");
                call.answer(localStream);
            });

            localStream.getVideoTracks()[0].onended = () => terminate();
        } catch (e) {
            alert("PCブラウザで「画面共有」を許可してください。");
        }
    }

    // --- 視聴側 ---
    function actAsViewer() {
        const id = document.getElementById('roomId').value.trim();
        if (!id) return alert("接続先IDを入力してください");

        updateStatus("ホストを探しています...", true);
        if (peer) peer.destroy();

        // 視聴側はランダムIDで開始
        peer = new Peer({ config: { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] } });

        peer.on('open', () => {
            // 接続試行
            const call = peer.call(id, new MediaStream());
            
            call.on('stream', (remoteStream) => {
                updateStatus("接続成功！映像を受信しています");
                videoEl.srcObject = remoteStream;
                showStopButton();
                
                // 自動再生に失敗したらボタンを出す（スマホ対策）
                videoEl.play().catch(() => {
                    playBtn.style.display = 'block';
                    updateStatus("ボタンを押して再生してください");
                });
            });

            // 10秒待っても反応がない場合
            setTimeout(() => {
                if (!videoEl.srcObject) {
                    updateStatus("ホストが見つかりません。IDを確認するか、ホストの配信開始を待ってください。");
                }
            }, 10000);
        });

        peer.on('error', (err) => {
            updateStatus("エラー: " + err.type);
            console.error(err);
        });
    }

    function showStopButton() {
        document.getElementById('inputArea').style.display = 'none';
        document.getElementById('controlBtns').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'block';
    }

    function terminate() {
        location.reload(); // 最も確実に初期化するためにリロードを使用
    }
</script>
</body>
</html>
