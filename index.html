<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multi-Screen Share Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #0081f2; --bg: #0f172a; --panel: #1e293b; --text: #f8fafc; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; min-height: 100vh; align-items: center; justify-content: center; }
        .container { width: 95%; max-width: 600px; background: var(--panel); padding: 25px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); text-align: center; }
        .video-box { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; margin: 15px 0; border: 1px solid #334155; }
        video { width: 100%; height: 100%; object-fit: contain; }
        .room-display { font-size: 32px; font-weight: bold; color: var(--primary); letter-spacing: 5px; margin: 10px 0; }
        input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: #fff; font-size: 20px; text-align: center; margin-bottom: 15px; outline: none; box-sizing: border-box; }
        input:focus { border-color: var(--primary); }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; margin-bottom: 10px; }
        .btn-host { background: var(--primary); color: white; }
        .btn-view { background: #22c55e; color: white; }
        .btn-stop { background: #ef4444; color: white; display: none; }
        #status { font-size: 13px; color: #94a3b8; margin-top: 10px; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 100; flex-direction: column; }
    </style>
</head>
<body>

<div class="container" id="setup">
    <h2 style="margin-top:0">Screen Share Pro</h2>
    <div id="status">ルームIDを入力して開始</div>
    
    <div class="room-display" id="displayId">-----</div>

    <div id="inputArea">
        <input type="number" id="roomId" placeholder="5桁の数字を入力" oninput="if(value.length>5)value=value.slice(0,5)">
        <button class="btn btn-view" onclick="startViewing()">視聴を開始する</button>
        <div style="margin: 15px 0; color: #64748b;">または</div>
        <button class="btn btn-host" onclick="startHosting()">新しく配信を開始 (PC)</button>
    </div>

    <div class="video-box">
        <video id="v" autoplay playsinline webkit-playsinline></video>
    </div>

    <button id="stopBtn" class="btn btn-stop" onclick="location.reload()">配信・視聴を終了</button>
</div>

<div id="playOverlay" class="overlay" onclick="forcePlay()">
    <button class="btn" style="width:auto; padding: 20px 40px; border-radius: 50px; background:#22c55e; color:#fff; font-size:20px;">▶ 視聴を開始</button>
</div>

<script>
    // Firebaseの設定 (公共のデモ用DB。商用利用時は自身のプロジェクト情報を推奨)
    const firebaseConfig = {
        databaseURL: "https://manus-screen-share-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const video = document.getElementById('v');
    const status = document.getElementById('status');
    const stopBtn = document.getElementById('stopBtn');
    const inputArea = document.getElementById('inputArea');
    const displayId = document.getElementById('displayId');
    const playOverlay = document.getElementById('playOverlay');

    let pc, localStream;
    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    function setStatus(msg) { status.innerText = msg; }

    function forcePlay() {
        video.play();
        playOverlay.style.display = 'none';
    }

    // --- 【配信側】PC用 ---
    async function startHosting() {
        const id = Math.floor(10000 + Math.random() * 90000).toString(); // 5桁生成
        try {
            localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            video.srcObject = localStream;
            video.muted = true;

            displayId.innerText = id;
            inputArea.style.display = 'none';
            stopBtn.style.display = 'block';
            setStatus("視聴者の接続を待機中...");

            // 誰かが接続してきたら（Offerが届いたら）応答する
            db.ref('rooms/' + id + '/offers').on('child_added', async (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                const peerConnection = new RTCPeerConnection(config);
                localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

                peerConnection.onicecandidate = (e) => {
                    if (e.candidate) db.ref('rooms/' + id + '/candidates/' + data.from).push(e.candidate);
                };

                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                db.ref('rooms/' + id + '/answers/' + data.from).set({ answer });
                setStatus("視聴者が1人追加されました");
            });

            // 終了処理
            localStream.getVideoTracks()[0].onended = () => location.reload();
            db.ref('rooms/' + id).onDisconnect().remove();

        } catch (e) { alert("PCで画面共有を許可してください"); }
    }

    // --- 【視聴側】スマホ・PC用 ---
    async function startViewing() {
        const id = document.getElementById('roomId').value;
        if (id.length !== 5) return alert("5桁の数字を入力してください");

        const myId = Math.random().toString(36).substring(7);
        setStatus("ホストに接続中...");
        
        pc = new RTCPeerConnection(config);
        
        pc.onicecandidate = (e) => {
            if (e.candidate) db.ref('rooms/' + id + '/candidates/host').push(e.candidate);
        };

        pc.ontrack = (e) => {
            video.srcObject = e.streams[0];
            setStatus("受信成功");
            video.play().catch(() => {
                playOverlay.style.display = 'flex';
            });
            inputArea.style.display = 'none';
            stopBtn.style.display = 'block';
            displayId.innerText = id;
        };

        const offer = await pc.createOffer({ offerToReceiveVideo: true, offerToReceiveAudio: true });
        await pc.setLocalDescription(offer);

        // Offerをデータベースに登録
        db.ref('rooms/' + id + '/offers').push({ offer, from: myId });

        // Answerを待機
        db.ref('rooms/' + id + '/answers/' + myId).on('value', async (snapshot) => {
            const data = snapshot.val();
            if (data && !pc.currentRemoteDescription) {
                await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
        });

        // ICE Candidateを待機
        db.ref('rooms/' + id + '/candidates/' + myId).on('child_added', (snapshot) => {
            const candidate = snapshot.val();
            if (candidate) pc.addIceCandidate(new RTCIceCandidate(candidate));
        });
    }
</script>
</body>
</html>
