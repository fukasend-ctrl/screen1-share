<script>
    let peer = null;
    let call = null; // 現在のコールを管理
    let retryCount = 0;

    function connect() {
        const id = document.getElementById('rid').value;
        const status = document.getElementById('status'); // 要素を明示的に取得
        const video = document.getElementById('v');

        if (id.length !== 5) return alert("5桁のコードを入力してください");

        // 【修正ポイント】既存の接続があれば「完全に」破棄してメモリを解放する
        if (peer) { 
            peer.destroy(); 
            peer = null;
        }

        status.innerText = "1/3: サーバーに接続中...";
        
        // PeerJSの設定（GoogleのSTUNサーバーを利用）
        peer = new Peer({ 
            config: { 
                iceServers: [
                    { urls: "stun:stun.l.google.com:19302" },
                    { urls: "stun:stun1.l.google.com:19302" },
                    { urls: "stun:stun2.l.google.com:19302" }
                ],
                iceCandidatePoolSize: 10
            } 
        });

        peer.on('open', (myId) => {
            status.innerText = "2/3: ホストを探索中...";
            
            // 接続試行（空のメディアストリームを添えるのがPeerJSの仕様）
            call = peer.call(id, new MediaStream());

            // タイムアウト監視（10秒進まなければリトライ）
            const timeout = setTimeout(() => {
                if (status.innerText.includes("探索中")) {
                    console.log("接続タイムアウトのためリトライします...");
                    retryCount++;
                    status.innerText = "再試行しています (回数: " + retryCount + ")...";
                    connect(); // 自身を呼び出して最初からやり直す
                }
            }, 10000);

            call.on('stream', (stream) => {
                clearTimeout(timeout); // 成功したのでタイマー解除
                status.innerText = "3/3: 受信成功！";
                video.srcObject = stream;
                video.style.display = 'block';
                document.getElementById('setup').style.display = 'none';
                
                // 自動再生（ミュート解除や再生権限の確認）
                video.play().catch(() => {
                    document.getElementById('playOverlay').style.display = 'flex';
                });
            });
        });

        // エラーハンドリング
        peer.on('error', (err) => {
            console.error("PeerJS Error:", err.type);
            if (err.type === 'peer-disconnected' || err.type === 'network') {
                status.innerText = "再接続を試みています...";
                setTimeout(connect, 3000);
            } else {
                status.innerText = "エラー: " + err.type;
            }
        });
    }

    // 再生ボタンが押された時の処理（iOS/Android対策）
    function forceStart() {
        const video = document.getElementById('v');
        video.play();
        document.getElementById('playOverlay').style.display = 'none';
    }
</script>
