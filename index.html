<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Screen Share Pro - Stable Connection</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #007aff; --bg: #000; --panel: #1c1c1e; --text: #fff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .video-section { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; background: #000; }
        
        /* 超重要な再生オーバーレイ */
        #playOverlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .play-inner { background: #32d74b; color: white; padding: 20px 40px; border-radius: 50px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 20px rgba(50,215,75,0.4); }

        .ui-panel { background: var(--panel); padding: 20px; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; gap: 15px; z-index: 100; }
        .room-info { font-size: 32px; font-weight: bold; color: var(--primary); text-align: center; letter-spacing: 5px; margin: 10px 0; }
        input { padding: 15px; border-radius: 12px; border: 1px solid #333; background: #2c2c2e; color: #fff; font-size: 20px; text-align: center; outline: none; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 15px; cursor: pointer; transition: 0.2s; }
        .btn-host { background: var(--primary); color: white; }
        .btn-view { background: #32d74b; color: white; }
        .btn-stop { background: #ff453a; color: white; display: none; width: 100%; }
        #status { font-size: 12px; color: #8e8e93; text-align: center; }
    </style>
</head>
<body>

<div class="video-section">
    <div id="playOverlay" onclick="manualPlay()">
        <div class="play-inner">▶ タップして映像を表示</div>
    </div>
    <video id="mainVideo" autoplay playsinline webkit-playsinline></video>
</div>

<div class="ui-panel">
    <div id="status">ルームIDを入力して開始してください</div>
    <div id="roomIdDisplay" class="room-info" style="display:none;"></div>
    
    <div id="setupArea" class="input-group" style="display:flex; flex-direction:column; gap:10px;">
        <input type="number" id="roomIdInput" placeholder="00000" oninput="if(value.length>5)value=value.slice(0,5)">
        <div class="btn-row">
            <button class="btn-view" onclick="actAsViewer()">視聴する</button>
            <button class="btn-host" onclick="actAsHost()">配信を開始(PC)</button>
        </div>
    </div>
    
    <button id="stopBtn" class="btn-stop" onclick="location.reload()">配信・視聴を終了</button>
</div>

<script>
    let peer = null;
    let localStream = null;
    const videoEl = document.getElementById('mainVideo');
    const statusEl = document.getElementById('status');
    const playOverlay = document.getElementById('playOverlay');
    const setupArea = document.getElementById('setupArea');
    const stopBtn = document.getElementById('stopBtn');
    const roomIdDisplay = document.getElementById('roomIdDisplay');

    function updateStatus(msg) { statusEl.innerText = msg; }

    // ブラウザの自動再生ブロックを解除するための関数
    async function manualPlay() {
        try {
            await videoEl.play();
            playOverlay.style.display = 'none';
            updateStatus("受信中");
        } catch (e) {
            console.error("Manual play failed", e);
        }
    }

    // --- 【ホスト側】配信を開始 ---
    async function actAsHost() {
        const id = Math.floor(10000 + Math.random() * 90000).toString();
        try {
            // 画面キャプチャの取得
            localStream = await navigator.mediaDevices.getDisplayMedia({
                video: { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { max: 30 } },
                audio: true
            });
            videoEl.srcObject = localStream;
            videoEl.muted = true; // 配信者側は自分の音を聞かない

            // 5桁のIDでPeerサーバーに登録
            peer = new Peer(id, {
                config: { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] },
                debug: 1
            });

            peer.on('open', () => {
                roomIdDisplay.innerText = id;
                roomIdDisplay.style.display = 'block';
                setupArea.style.display = 'none';
                stopBtn.style.display = 'block';
                updateStatus("配信中... 視聴者を待っています");
            });

            // 視聴者からの着信（Call）を待ち受ける
            peer.on('call', (call) => {
                // 接続してきた視聴者に自分の画面（localStream）を送る
                call.answer(localStream);
                updateStatus("視聴者が接続しました");
            });

            // 配信が手動で停止されたら終了
            localStream.getVideoTracks()[0].onended = () => location.reload();

        } catch (e) {
            alert("画面共有を開始できませんでした。PCブラウザであることを確認してください。");
        }
    }

    // --- 【視聴者側】接続を開始 ---
    function actAsViewer() {
        const targetId = document.getElementById('roomIdInput').value;
        if (targetId.length !== 5) return alert("5桁のコードを入力してください");

        updateStatus("ホストに接続中...");
        if (peer) peer.destroy();

        // 視聴側はランダムなIDで作成
        peer = new Peer({
            config: { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] },
            debug: 1
        });

        peer.on('open', () => {
            // 配信者（5桁ID）を呼び出す（こちらからのストリームは空でOK）
            const call = peer.call(targetId, new MediaStream());
            
            // 相手からの映像ストリームが届いた時の処理
            call.on('stream', (remoteStream) => {
                updateStatus("映像パケット受信...");
                videoEl.srcObject = remoteStream;
                setupArea.style.display = 'none';
                stopBtn.style.display = 'block';
                roomIdDisplay.innerText = "CONNECTED: " + targetId;
                roomIdDisplay.style.display = 'block';

                // iOS/Androidでの自動再生拒否を回避
                videoEl.play().then(() => {
                    updateStatus("受信成功");
                }).catch(() => {
                    playOverlay.style.display = 'flex';
                    updateStatus("映像をタップして表示");
                });
            });

            // 接続が確立しなかった場合のタイムアウト設定
            setTimeout(() => {
                if (!videoEl.srcObject) {
                    updateStatus("ホストが見つかりません。IDが正しいか、配信が開始されているか確認してください。");
                }
            }, 8000);
        });

        peer.on('error', (err) => {
            console.error(err);
            alert("接続エラーが発生しました。");
            updateStatus("待機中");
        });
    }
</script>
</body>
</html>
