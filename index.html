<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P Direct Screen Share</title>
    <style>
        :root { --primary: #00ff41; --bg: #0a0a0a; --panel: #1a1a1a; --text: #00ff41; }
        body { font-family: 'Courier New', monospace; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .container { width: 100%; max-width: 800px; border: 1px solid var(--primary); padding: 20px; border-radius: 8px; box-shadow: 0 0 20px rgba(0,255,65,0.2); }
        h1 { font-size: 1.2rem; text-align: center; border-bottom: 1px solid var(--primary); padding-bottom: 10px; }
        video { width: 100%; aspect-ratio: 16/9; background: #000; border: 1px solid #333; margin: 10px 0; border-radius: 4px; }
        textarea { width: 100%; height: 100px; background: #000; color: var(--primary); border: 1px solid var(--primary); padding: 10px; box-sizing: border-box; font-size: 12px; margin: 10px 0; resize: none; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        button { background: transparent; color: var(--primary); border: 1px solid var(--primary); padding: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: var(--primary); color: #000; }
        .step { margin: 20px 0; padding: 15px; background: var(--panel); border-radius: 4px; }
        .label { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; display: block; }
        #status { color: #fff; font-size: 0.9rem; text-align: center; margin: 10px 0; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>[ SYSTEM: DIRECT_P2P_SCREEN_STREAM ]</h1>
    
    <div id="status">READY: 通信待機中</div>

    <video id="v" autoplay playsinline controls></video>

    <div id="setupArea">
        <div class="controls">
            <button onclick="initHost()">1. 配信を開始 (PC)</button>
            <button onclick="initGuest()">1. 視聴を開始 (スマホ/PC)</button>
        </div>
    </div>

    <div id="commArea" class="hidden">
        <div class="step">
            <span class="label" id="copyLabel">あなたの接続コード (これを相手に送ってください):</span>
            <textarea id="localSdp" readonly onclick="this.select()"></textarea>
            <button style="width: 100%;" onclick="copyCode()">コードをコピー</button>
        </div>

        <div class="step">
            <span class="label">相手から受け取ったコードを貼り付けてください:</span>
            <textarea id="remoteSdp" placeholder="ここに貼り付け"></textarea>
            <button style="width: 100%; background: var(--primary); color: #000;" onclick="connect()">2. 接続を確立する</button>
        </div>
    </div>
    
    <button id="stopBtn" class="hidden" style="width:100%; margin-top:10px; border-color: #ff4141; color: #ff4141;" onclick="location.reload()">システム終了</button>
</div>

<script>
    const v = document.getElementById('v');
    const localSdp = document.getElementById('localSdp');
    const remoteSdp = document.getElementById('remoteSdp');
    const status = document.getElementById('status');
    let pc, stream;

    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    function setStatus(msg) { status.innerText = "STATUS: " + msg; }

    function createPC() {
        pc = new RTCPeerConnection(config);
        pc.onicecandidate = (e) => {
            if (!e.candidate) {
                localSdp.value = btoa(JSON.stringify(pc.localDescription));
                setStatus("あなたのコードが生成されました。相手に送ってください。");
            }
        };
        pc.ontrack = (e) => {
            v.srcObject = e.streams[0];
            setStatus("接続成功：ストリームを受信中");
            v.play().catch(() => setStatus("再生ボタンを押してください"));
        };
        pc.oniceconnectionstatechange = () => {
            if(pc.iceConnectionState === 'connected') setStatus("P2P接続確立！");
        };
    }

    async function initHost() {
        try {
            stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            v.srcObject = stream;
            v.muted = true;
            createPC();
            stream.getTracks().forEach(t => pc.addTrack(t, stream));
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            showCommArea("OFFER (配信側)");
        } catch (e) { alert("画面共有に失敗しました"); }
    }

    async function initGuest() {
        createPC();
        showCommArea("ANSWER (視聴側)");
        setStatus("配信者からのコードを貼り付けてください");
    }

    async function connect() {
        const data = JSON.parse(atob(remoteSdp.value));
        if (data.type === "offer") {
            await pc.setRemoteDescription(new RTCSessionDescription(data));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            setStatus("あなたのコードを配信者に送り返してください");
        } else if (data.type === "answer") {
            await pc.setRemoteDescription(new RTCSessionDescription(data));
            setStatus("接続処理中...");
        }
    }

    function showCommArea(mode) {
        document.getElementById('setupArea').classList.add('hidden');
        document.getElementById('commArea').classList.remove('hidden');
        document.getElementById('stopBtn').classList.remove('hidden');
        setStatus(mode + " モード起動");
    }

    function copyCode() {
        localSdp.select();
        document.execCommand('copy');
        alert("コードをコピーしました。LINEやメール等で相手に送ってください。");
    }
</script>
</body>
</html>
