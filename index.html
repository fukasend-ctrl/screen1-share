<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>ç”»é¢å…±æœ‰ãƒ—ãƒ­ v2</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box; }
        .container { background: #1e1e1e; padding: 20px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; max-width: 1000px; text-align: center; }
        
        .video-wrapper { position: relative; width: 100%; background: #000; border-radius: 12px; overflow: hidden; aspect-ratio: 16 / 9; margin-top: 15px; display: flex; align-items: center; justify-content: center; border: 1px solid #333; }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        .controls { margin-bottom: 20px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        input { padding: 12px; border: 1px solid #333; border-radius: 8px; background: #2d2d2d; color: white; width: 180px; outline: none; transition: 0.3s; }
        input:focus { border-color: #0081f2; background: #333; }
        
        button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .btn-share { background: #0081f2; color: white; }
        .btn-view { background: #25ba3b; color: white; }
        .btn-stop { background: #f25a5a; color: white; display: none; } /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        
        button:hover { opacity: 0.8; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button:disabled { background: #555; cursor: not-allowed; opacity: 0.5; }
        
        #status { font-size: 0.85rem; color: #aaa; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; display: inline-block; width: 100%; max-width: 500px; box-sizing: border-box; }
        h1 { font-size: 1.4rem; margin: 10px 0 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Simple Screen Share</h1>
    
    <div class="controls">
        <input type="text" id="roomId" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›">
        <button id="hostBtn" class="btn-share" onclick="startHosting()">
            <span>â–¶</span> å…±æœ‰ã‚’é–‹å§‹
        </button>
        <button id="viewBtn" class="btn-view" onclick="startViewing()">
            <span>ğŸ‘</span> è¦–è´ã™ã‚‹
        </button>
        <button id="stopBtn" class="btn-stop" onclick="stopSharing()">
            <span>â– </span> å…±æœ‰ã‚’åœæ­¢
        </button>
    </div>

    <div id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¾…æ©Ÿä¸­</div>

    <div class="video-wrapper">
        <video id="remoteVideo" autoplay playsinline webkit-playsinline controls></video>
    </div>
</div>

<script>
    let peer = null;
    let localStream = null;
    let currentCall = null;

    const hostBtn = document.getElementById('hostBtn');
    const viewBtn = document.getElementById('viewBtn');
    const stopBtn = document.getElementById('stopBtn');
    const videoEl = document.getElementById('remoteVideo');

    function setStatus(msg) {
        document.getElementById('status').innerText = 'â— ' + msg;
    }

    // --- å…±æœ‰ã‚’åœæ­¢ã™ã‚‹é–¢æ•° ---
    function stopSharing() {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        if (peer) {
            peer.destroy();
            peer = null;
        }
        videoEl.srcObject = null;
        
        // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        hostBtn.style.display = 'inline-flex';
        viewBtn.style.display = 'inline-flex';
        stopBtn.style.display = 'none';
        
        setStatus('å…±æœ‰ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚');
    }

    // --- ãƒ›ã‚¹ãƒˆï¼ˆå…±æœ‰å´ï¼‰ã®é–‹å§‹ ---
    async function startHosting() {
        const id = document.getElementById('roomId').value;
        if (!id) return alert('ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

        try {
            // ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ã®é–‹å§‹
            localStream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: "always" },
                audio: true
            });

            videoEl.srcObject = localStream;
            
            // PeerJSæ¥ç¶šï¼ˆIDã‚’æŒ‡å®šï¼‰
            peer = new Peer(id);
            
            peer.on('open', () => {
                setStatus(`å…±æœ‰ä¸­ï¼ç›¸æ‰‹ã«IDã€Œ${id}ã€ã‚’ä¼ãˆã¦ãã ã•ã„ã€‚`);
                hostBtn.style.display = 'none';
                viewBtn.style.display = 'none';
                stopBtn.style.display = 'inline-flex';
            });

            // è¦–è´è€…ã‹ã‚‰ã®ç€ä¿¡
            peer.on('call', (call) => {
                call.answer(localStream);
                setStatus('è¦–è´è€…ãŒæ¥ç¶šã—ã¾ã—ãŸã€‚');
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    alert('ãã®IDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®IDã‚’è©¦ã—ã¦ãã ã•ã„ã€‚');
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.type);
                }
                stopSharing();
            });

            // ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®ã€Œå…±æœ‰ã‚’åœæ­¢ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚
            localStream.getVideoTracks()[0].onended = () => {
                stopSharing();
            };

        } catch (err) {
            console.error(err);
            setStatus('ã‚¨ãƒ©ãƒ¼: å…±æœ‰ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚');
        }
    }

    // --- ãƒªã‚¹ãƒŠãƒ¼ï¼ˆè¦–è´å´ï¼‰ã®é–‹å§‹ ---
    function startViewing() {
        const id = document.getElementById('roomId').value;
        if (!id) return alert('æ¥ç¶šå…ˆã®ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

        if(peer) peer.destroy();
        peer = new Peer();
        
        peer.on('open', () => {
            setStatus('æ¥ç¶šã‚’è©¦ã¿ã¦ã„ã¾ã™...');
            
            // ç›¸æ‰‹ã«æ¥ç¶šã€‚å—ä¿¡ã®ã¿ãªã®ã§ç©ºã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’æ¸¡ã™ã‹ã€PeerJSã®ä»•æ§˜ã«åˆã‚ã›ã¦ã‚³ãƒ¼ãƒ«
            const call = peer.call(id, new MediaStream());
            currentCall = call;

            call.on('stream', (remoteStream) => {
                videoEl.srcObject = remoteStream;
                
                // è‡ªå‹•å†ç”Ÿå¯¾ç­–
                videoEl.play().catch(() => {
                    setStatus('å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å†ç”Ÿã—ã¦ãã ã•ã„ã€‚');
                });
                
                setStatus('è¦–è´ä¸­ï¼šå…±æœ‰ç”»é¢ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚');
                hostBtn.style.display = 'none';
                viewBtn.style.display = 'none';
                stopBtn.innerText = 'è¦–è´ã‚’çµ‚äº†';
                stopBtn.style.display = 'inline-flex';
            });

            call.on('error', (err) => {
                alert('æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚IDãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                stopSharing();
            });
        });

        peer.on('error', (err) => {
            setStatus('æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + err.type);
        });
    }
</script>

</body>
</html>
